(()=>{let c,d=null;window.initializeSupabase=({supabaseUrl:e,supabaseKey:t})=>{e&&t?c=Supabase.createClient(e,t):console.error("Supabase URL and Key must be provided.")};const p=(e,t="success")=>{const n=document.querySelector(".bflow-feedback");n&&n.remove();const s=document.createElement("div");s.innerText=e,s.className=`bflow-feedback ${t}`,Object.assign(s.style,{position:"fixed",bottom:"10px",right:"10px",background:"success"===t?"green":"red",color:"white",padding:"10px",borderRadius:"5px",zIndex:9999,fontFamily:"sans-serif"}),document.body.appendChild(s),setTimeout(()=>s.remove(),3e3)},r=async()=>{if(!c)return null;const{data:{user:e}}=await c.auth.getUser();return d=e,e},u=async()=>{const e=document.querySelector("body");if(!e)return;const t=e.getAttribute("bflow-sb-page-access"),n=e.getAttribute("bflow-sb-page-redirect");if(!t)return;await r();let s=!1;"authenticated"===t?s=!!d:"unauthenticated"===t?s=!d:d&&d.role===t?s=!0:"premium"===t&&(s=d&&d.user_metadata&&d.user_metadata.premium),!s&&n&&(window.location.href=n)},h=async()=>{const e=document.querySelectorAll("[bflow-sb-visibility]");await r(),e.forEach(l=>{const f=l.getAttribute("bflow-sb-visibility"),g="true"===l.getAttribute("bflow-sb-visibility-hide-if");let v=!1;"authenticated"===f?v=!d:"unauthenticated"===f?v=!!d:v=!(d&&d.role===f);const m=g?v:!v;l.style.display=m?"none":""})},y=async()=>{const e=document.querySelectorAll("[bflow-sb-role]");await r(),e.forEach(l=>{const f=l.getAttribute("bflow-sb-role"),g="true"===l.getAttribute("bflow-sb-role-hide-if"),v=d&&d.role===f;let m=!1;g&&v&&(m=!0),!g&&!v&&(m=!0),l.style.display=m?"none":""})},E=()=>{const e=document.querySelectorAll("[bflow-sb-error]");e.forEach(t=>{const n="show"===t.getAttribute("bflow-sb-error"),s=t.getAttribute("bflow-sb-error-message")||"An error occurred.";n?(t.innerText=s,t.style.display="block"):t.style.display="none"})},b=async()=>{const e=document.querySelectorAll("[bflow-sb-content='dynamic']");await r();for(const t of e){const n=t.getAttribute("bflow-sb-content-table"),s=t.getAttribute("bflow-sb-content-field");if(!n||!s)continue;try{const{data:l,error:f}=await c.from(n).select(s);if(f)throw f;l&&l.length>0&&(t.innerText=l.map(m=>m[s]).join(", "))}catch(l){console.error("Error fetching dynamic content:",l),p("Error loading content","error")}}},w=()=>{document.addEventListener("click",e=>{const t=e.target.closest("[bflow-sb-track]");if(t){const n=t.getAttribute("bflow-sb-track");console.log(`Event Tracked: ${n}`)}})},S=()=>{document.addEventListener("click",e=>{const t=e.target.closest("[bflow-sb-confirm]");if(t){e.preventDefault();const n=t.getAttribute("bflow-sb-confirm-target"),s=document.getElementById(n);if(!s){console.error("Modal not found:",n);return}s.style.display="block";const l=s.querySelector("[bflow-sb-confirm-button='true']"),f=s.querySelector("[bflow-sb-cancel-button='true']"),g=()=>{s.style.display="none";const v=t.getAttribute("bflow-sb-confirm"),m=t.getAttribute("bflow-sb-confirm-target");t.removeAttribute("bflow-sb-confirm"),t.removeAttribute("bflow-sb-confirm-target"),t.click(),t.setAttribute("bflow-sb-confirm",v),t.setAttribute("bflow-sb-confirm-target",m)};l&&(l.onclick=g),f&&(f.onclick=()=>{s.style.display="none"})}})},A=(e,t)=>{if(!e)return;const n=e.getAttribute("bflow-sb-loading");"true"===n&&(e.disabled=t,e.style.opacity=t?"0.5":"1")},C=e=>{e&&(document.querySelectorAll("[bflow-sb-refresh-on-success='true']").length>0&&window.location.reload())},L=()=>{document.addEventListener("submit",async e=>{const t=e.target.closest("[bflow-sb-form]");if(!t)return;e.preventDefault(),A(t,!0);const n=t.getAttribute("bflow-sb-form");let s,l,f,g={};const v=t.querySelectorAll("[bflow-sb-input]");v.forEach(o=>{const i=o.getAttribute("bflow-sb-input"),a=o.getAttribute("bflow-sb-input-field")||i;g[a]=o.value});let m=!1;try{if("auth"===n){s=t.getAttribute("bflow-sb-auth");const o=t.getAttribute("bflow-sb-auth-redirect");let i;if("login"===s)i=await c.auth.signInWithPassword({email:g.email,password:g.password});else if("signup"===s){i=await c.auth.signUp({email:g.email,password:g.password,...g.name?{data:{name:g.name}}:{}})}else"logout"===s?i=await c.auth.signOut():"check"===s?i=await c.auth.getUser():"reset-password"===s&&(i=await c.auth.resetPasswordForEmail(g.email));i&&!i.error?(m=!0,p(`Auth ${s} successful`,"success"),o&&(window.location.href=o)):i&&i.error&&p(`Error: ${i.error.message}`,"error"),await r()}else if("crud"===n){s=t.getAttribute("bflow-sb-crud"),l=t.getAttribute("bflow-sb-crud-table"),f=t.getAttribute("bflow-sb-crud-id");const o=t.getAttribute("bflow-sb-crud-payload");if(o)try{const i=JSON.parse(o);g={...g,...i}}catch(i){console.error("Invalid JSON in bflow-sb-crud-payload:",i)}let i;if("create"===s)i=await c.from(l).insert(g);else if("read"===s)i=await c.from(l).select();else if("update"===s){if(!f){console.error("No ID provided for update operation."),p("No ID provided for update.","error")}else i=await c.from(l).update(g).eq("id",f)}else if("delete"===s){if(!f){console.error("No ID provided for delete operation."),p("No ID provided for delete.","error")}else i=await c.from(l).delete().eq("id",f)}i&&!i.error?(m=!0,p(`CRUD ${s} successful`,"success")):i&&i.error&&p(`Error: ${i.error.message}`,"error")}C(m)}catch(o){console.error("Error:",o),p(`Error: ${o.message}`,"error")}finally{A(t,!1)}})},R=()=>{document.addEventListener("click",async e=>{const t=e.target.closest("[bflow-sb-crud],[bflow-sb-auth],[bflow-sb-confirm]");if(!t||t.hasAttribute("bflow-sb-form"))return;if(t.hasAttribute("bflow-sb-confirm"))return;A(t,!0);let n=!1;try{if(t.hasAttribute("bflow-sb-auth")){const s=t.getAttribute("bflow-sb-auth"),l=t.getAttribute("bflow-sb-auth-email"),f=t.getAttribute("bflow-sb-auth-password"),g=t.getAttribute("bflow-sb-auth-redirect");let v;if("login"===s)v=await c.auth.signInWithPassword({email:l,password:f});else if("signup"===s)v=await c.auth.signUp({email:l,password:f});else"logout"===s?v=await c.auth.signOut():"check"===s?v=await c.auth.getUser():"reset-password"===s&&(v=await c.auth.resetPasswordForEmail(l));v&&!v.error?(p(`Auth ${s} successful`,"success"),n=!0,g&&(window.location.href=g)):v&&v.error&&p(`Error: ${v.error.message}`,"error"),await r()}if(t.hasAttribute("bflow-sb-crud")){const s=t.getAttribute("bflow-sb-crud"),l=t.getAttribute("bflow-sb-crud-table"),f=t.getAttribute("bflow-sb-crud-id"),g=t.getAttribute("bflow-sb-crud-payload");let v={};if(g)try{v=JSON.parse(g)}catch(i){console.error("Invalid JSON in bflow-sb-crud-payload:",i)}let m;if("create"===s)m=await c.from(l).insert(v);else if("read"===s)m=await c.from(l).select();else if("update"===s){if(!f)p("No ID provided for update.","error");else m=await c.from(l).update(v).eq("id",f)}else if("delete"===s){if(!f)p("No ID provided for delete.","error");else m=await c.from(l).delete().eq("id",f)}m&&!m.error?(p(`CRUD ${s} successful`,"success"),n=!0):m&&m.error&&p(`Error: ${m.error.message}`,"error")}C(n)}catch(s){console.error("Error:",s),p(`Error: ${s.message}`,"error")}finally{A(t,!1)}})},D=async()=>{await r(),await u(),await h(),await y(),E(),await b(),w(),S(),L(),R()};document.addEventListener("DOMContentLoaded",D);})();
